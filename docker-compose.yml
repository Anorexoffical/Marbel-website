services:
  mongo:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  server:
    build: ./server
    environment:
      - PORT=${SERVER_PORT:-3008}
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017/marble}
      - CLIENT_URL=${SITE_BASE_URL:-http://localhost:5173}
    depends_on:
      - mongo
    ports:
      - "${SERVER_PORT:-3008}:3008"
    volumes:
      - ./server/uploads:/app/uploads
    # Run setup script before starting the server
    command: sh -c "node createAdmin.js && node server.js"

  # Development frontend (Vite dev server on 5173)
  client-dev:
    image: node:22-alpine
    working_dir: /app
    profiles: ["dev"]
    environment:
      - VITE_API_BASE=${API_BASE_URL:-http://localhost:3008/api}
      - VITE_UPLOADS_BASE=${UPLOADS_BASE_URL:-http://localhost:3008/uploads}
      - VITE_SITE_BASE=${SITE_BASE_URL:-http://localhost:5173}
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "${CLIENT_PORT:-5173}:5173"
    depends_on:
      - server

  # Production frontend (Nginx serving built assets, mapped to host 5173)
  client-prod:
    build:
      context: .
      args:
        VITE_API_BASE: ${API_BASE_URL:-http://localhost:3008/api}
        VITE_UPLOADS_BASE: ${UPLOADS_BASE_URL:-http://localhost:3008/uploads}
        VITE_SITE_BASE: ${SITE_BASE_URL:-http://localhost:5173}
    profiles: ["server"]
    ports:
      - "${CLIENT_PORT:-5173}:80"
    depends_on:
      - server

volumes:
  mongo_data: